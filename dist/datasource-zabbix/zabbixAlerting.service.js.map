{"version":3,"sources":["../../src/datasource-zabbix/zabbixAlerting.service.js"],"names":["_","$","angular","ZabbixAlertingService","dashboardSrv","panelId","alertState","panelContainers","filter","elem","clientHeight","clientWidth","panelModels","getPanelModels","panelIndex","findIndex","panel","id","alertClass","removeClass","addClass","flatten","map","dash","rows","row","collapse","panels","find","threshold","getPanelModel","containsThreshold","thresholds","value","type","thresholdOptions","colorMode","fill","line","lineColor","op","source","push","module","service"],"mappings":"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","file":"zabbixAlerting.service.js","sourcesContent":["import _ from 'lodash';\nimport $ from 'jquery';\nimport angular from 'angular';\n\nclass ZabbixAlertingService {\n\n  /** @ngInject */\n  constructor(dashboardSrv) {\n    this.dashboardSrv = dashboardSrv;\n  }\n\n  setPanelAlertState(panelId, alertState) {\n    let panelContainers = _.filter($('.panel-container'), elem => {\n      return elem.clientHeight && elem.clientWidth;\n    });\n\n    let panelModels = this.getPanelModels();\n    let panelIndex = _.findIndex(panelModels, panel => {\n      return panel.id === panelId;\n    });\n\n    if (panelIndex >= 0) {\n      let alertClass = \"panel-has-alert panel-alert-state--ok panel-alert-state--alerting\";\n      $(panelContainers[panelIndex]).removeClass(alertClass);\n\n      if (alertState) {\n        if (alertState === 'alerting') {\n          alertClass = \"panel-has-alert panel-alert-state--\" + alertState;\n          $(panelContainers[panelIndex]).addClass(alertClass);\n        }\n        if (alertState === 'ok') {\n          alertClass = \"panel-alert-state--\" + alertState;\n          $(panelContainers[panelIndex]).addClass(alertClass);\n          $(panelContainers[panelIndex]).removeClass(\"panel-has-alert\");\n        }\n      }\n    }\n  }\n\n  getPanelModels() {\n    return _.flatten(_.map(this.dashboardSrv.dash.rows, row => {\n      if (row.collapse) {\n        return [];\n      } else {\n        return row.panels;\n      }\n    }));\n  }\n\n  getPanelModel(panelId) {\n    let panelModels = this.getPanelModels();\n\n    return _.find(panelModels, panel => {\n      return panel.id === panelId;\n    });\n  }\n\n  setPanelThreshold(panelId, threshold) {\n    let panel = this.getPanelModel(panelId);\n    let containsThreshold = _.find(panel.thresholds, {value: threshold});\n\n    if (panel && panel.type === \"graph\" && !containsThreshold) {\n      let thresholdOptions = {\n        colorMode : \"custom\",\n        fill : false,\n        line : true,\n        lineColor: \"rgb(255, 0, 0)\",\n        op: \"gt\",\n        value: threshold,\n        source: \"zabbix\"\n      };\n\n      panel.thresholds.push(thresholdOptions);\n    }\n  }\n\n  removeZabbixThreshold(panelId) {\n    let panel = this.getPanelModel(panelId);\n\n    if (panel && panel.type === \"graph\") {\n      panel.thresholds = _.filter(panel.thresholds, threshold => {\n        return threshold.source !== \"zabbix\";\n      });\n    }\n  }\n\n}\n\nangular\n  .module('grafana.services')\n  .service('zabbixAlertingSrv', ZabbixAlertingService);\n"]}