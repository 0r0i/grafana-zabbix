{"version":3,"sources":["../../src/datasource-zabbix/zabbixCachingProxy.service.js"],"names":["ZabbixCachingProxyFactory","ZabbixCachingProxy","zabbixAPI","cacheOptions","cacheEnabled","enabled","ttl","cache","groups","hosts","applications","items","history","trends","historyPromises","getHistory","callAPIRequestOnce","_","bind","getHistoryRequestHash","groupPromises","getGroupsOnce","getGroups","getRequestHash","hostPromises","getHostsOnce","getHosts","appPromises","getAppsOnce","getApps","itemPromises","getItemsOnce","getItems","cacheObject","object_age","Date","now","timestamp","request","params","hash","isExpired","Promise","resolve","value","then","result","proxyRequest","groupids","hostids","appids","itemtype","time_from","time_till","historyStorage","full_history","expired","filter","keyBy","item","itemid","length","grouped_history","groupBy","forEach","map","flatten","func","promiseKeeper","argsHashFunc","arguments","apply","args","requestStamp","arg","undefined","isArray","sort","toString","join","getHash","itemids","stamp","angular","module","factory","String","prototype","i","chr","len","charCodeAt","indexBy"],"mappings":"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","file":"zabbixCachingProxy.service.js","sourcesContent":["import angular from 'angular';\nimport _ from 'lodash';\n\n// Use factory() instead service() for multiple datasources support.\n// Each datasource instance must initialize its own cache.\n\n/** @ngInject */\nfunction ZabbixCachingProxyFactory() {\n\n  class ZabbixCachingProxy {\n    constructor(zabbixAPI, cacheOptions) {\n      this.zabbixAPI = zabbixAPI;\n      this.cacheEnabled = cacheOptions.enabled;\n      this.ttl          = cacheOptions.ttl || 600000; // 10 minutes by default\n\n      // Internal objects for data storing\n      this.cache = {\n        groups: {},\n        hosts: {},\n        applications: {},\n        items: {},\n        history: {},\n        trends: {}\n      };\n\n      this.historyPromises = {};\n\n      // Don't run duplicated history requests\n      this.getHistory = callAPIRequestOnce(_.bind(this.zabbixAPI.getHistory, this.zabbixAPI),\n                                           this.historyPromises, getHistoryRequestHash);\n\n      // Don't run duplicated requests\n      this.groupPromises = {};\n      this.getGroupsOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getGroups, this.zabbixAPI),\n                                              this.groupPromises, getRequestHash);\n\n      this.hostPromises = {};\n      this.getHostsOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getHosts, this.zabbixAPI),\n                                             this.hostPromises, getRequestHash);\n\n      this.appPromises = {};\n      this.getAppsOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getApps, this.zabbixAPI),\n                                            this.appPromises, getRequestHash);\n\n      this.itemPromises = {};\n      this.getItemsOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getItems, this.zabbixAPI),\n                                             this.itemPromises, getRequestHash);\n    }\n\n    isExpired(cacheObject) {\n      if (cacheObject) {\n        let object_age = Date.now() - cacheObject.timestamp;\n        return !(cacheObject.timestamp && object_age < this.ttl);\n      } else {\n        return true;\n      }\n    }\n\n    /**\n     * Check that result is present in cache and up to date\n     * or send request to API.\n     */\n    proxyRequest(request, params, cacheObject) {\n      let hash = getRequestHash(params);\n      if (this.cacheEnabled && !this.isExpired(cacheObject[hash])) {\n        return Promise.resolve(cacheObject[hash].value);\n      } else {\n        return request(...params)\n        .then(result => {\n          cacheObject[hash] = {\n            value: result,\n            timestamp: Date.now()\n          };\n          return result;\n        });\n      }\n    }\n\n    getGroups() {\n      return this.proxyRequest(this.getGroupsOnce, [], this.cache.groups);\n    }\n\n    getHosts(groupids) {\n      return this.proxyRequest(this.getHostsOnce, [groupids], this.cache.hosts);\n    }\n\n    getApps(hostids) {\n      return this.proxyRequest(this.getAppsOnce, [hostids], this.cache.applications);\n    }\n\n    getItems(hostids, appids, itemtype) {\n      let params = [hostids, appids, itemtype];\n      return this.proxyRequest(this.getItemsOnce, params, this.cache.items);\n    }\n\n    getHistoryFromCache(items, time_from, time_till) {\n      var historyStorage = this.cache.history;\n      var full_history;\n      var expired = _.filter(_.keyBy(items, 'itemid'), (item, itemid) => {\n        return !historyStorage[itemid];\n      });\n      if (expired.length) {\n        return this.zabbixAPI.getHistory(expired, time_from, time_till).then(function(history) {\n          var grouped_history = _.groupBy(history, 'itemid');\n          _.forEach(expired, item => {\n            var itemid = item.itemid;\n            historyStorage[itemid] = item;\n            historyStorage[itemid].time_from = time_from;\n            historyStorage[itemid].time_till = time_till;\n            historyStorage[itemid].history = grouped_history[itemid];\n          });\n          full_history = _.map(items, item => {\n            return historyStorage[item.itemid].history;\n          });\n          return _.flatten(full_history, true);\n        });\n      } else {\n        full_history = _.map(items, function(item) {\n          return historyStorage[item.itemid].history;\n        });\n        return Promise.resolve(_.flatten(full_history, true));\n      }\n    }\n\n    getHistoryFromAPI(items, time_from, time_till) {\n      return this.zabbixAPI.getHistory(items, time_from, time_till);\n    }\n  }\n\n  return ZabbixCachingProxy;\n}\n\nangular\n  .module('grafana.services')\n  .factory('ZabbixCachingProxy', ZabbixCachingProxyFactory);\n\n/**\n * Wrap zabbix API request to prevent multiple calls\n * with same params when waiting for result.\n */\nfunction callAPIRequestOnce(func, promiseKeeper, argsHashFunc) {\n  return function() {\n    var hash = argsHashFunc(arguments);\n    if (!promiseKeeper[hash]) {\n      promiseKeeper[hash] = Promise.resolve(\n        func.apply(this, arguments)\n        .then(result => {\n          promiseKeeper[hash] = null;\n          return result;\n        })\n      );\n    }\n    return promiseKeeper[hash];\n  };\n}\n\nfunction getRequestHash(args) {\n  var requestStamp = _.map(args, arg => {\n    if (arg === undefined) {\n      return 'undefined';\n    } else {\n      if (_.isArray(arg)) {\n        return arg.sort().toString();\n      } else {\n        return arg.toString();\n      }\n    }\n  }).join();\n  return requestStamp.getHash();\n}\n\nfunction getHistoryRequestHash(args) {\n  let itemids = _.map(args[0], 'itemid');\n  let stamp = itemids.join() + args[1] + args[2];\n  return stamp.getHash();\n}\n\nString.prototype.getHash = function() {\n  var hash = 0, i, chr, len;\n  if (this.length !== 0) {\n    for (i = 0, len = this.length; i < len; i++) {\n      chr   = this.charCodeAt(i);\n      hash  = ((hash << 5) - hash) + chr;\n      hash |= 0; // Convert to 32bit integer\n    }\n  }\n  return hash;\n};\n\n// Fix for backward compatibility with lodash 2.4\nif (!_.keyBy) {_.keyBy = _.indexBy;}\n"]}