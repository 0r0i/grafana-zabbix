{"version":3,"sources":["../../src/datasource-zabbix/zabbixCachingProxy.service.js"],"names":["ZabbixCachingProxyFactory","ZabbixCachingProxy","zabbixAPI","zabbixDBConnector","cacheOptions","dbConnector","cacheEnabled","enabled","ttl","cache","groups","hosts","applications","items","history","trends","macros","globalMacros","historyPromises","getHistory","callAPIRequestOnce","_","bind","getHistoryRequestHash","getHistoryDB","getDBQueryHash","getTrendsDB","getTrends","groupPromises","getGroupsOnce","getGroups","getRequestHash","hostPromises","getHostsOnce","getHosts","appPromises","getAppsOnce","getApps","itemPromises","getItemsOnce","getItems","macroPromises","getMacrosOnce","getMacros","globalMacroPromises","getGlobalMacrosOnce","getGlobalMacros","cacheObject","object_age","Date","now","timestamp","request","params","hash","isExpired","Promise","resolve","value","then","result","proxyRequest","groupids","hostids","appids","itemtype","promises","all","flatten","time_from","time_till","historyStorage","full_history","expired","filter","keyBy","item","itemid","length","grouped_history","groupBy","forEach","map","func","promiseKeeper","argsHashFunc","arguments","apply","args","requestStamp","arg","undefined","isArray","sort","toString","join","getHash","itemids","stamp","consolidateBy","intervalMs","angular","module","factory","String","prototype","i","chr","len","charCodeAt","indexBy"],"mappings":"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","file":"zabbixCachingProxy.service.js","sourcesContent":["import angular from 'angular';\nimport _ from 'lodash';\n\n// Use factory() instead service() for multiple datasources support.\n// Each datasource instance must initialize its own cache.\n\n/** @ngInject */\nfunction ZabbixCachingProxyFactory() {\n\n  class ZabbixCachingProxy {\n    constructor(zabbixAPI, zabbixDBConnector, cacheOptions) {\n      this.zabbixAPI = zabbixAPI;\n      this.dbConnector = zabbixDBConnector;\n      this.cacheEnabled = cacheOptions.enabled;\n      this.ttl          = cacheOptions.ttl || 600000; // 10 minutes by default\n\n      // Internal objects for data storing\n      this.cache = {\n        groups: {},\n        hosts: {},\n        applications: {},\n        items: {},\n        history: {},\n        trends: {},\n        macros: {},\n        globalMacros: {}\n      };\n\n      this.historyPromises = {};\n\n      // Don't run duplicated history requests\n      this.getHistory = callAPIRequestOnce(_.bind(this.zabbixAPI.getHistory, this.zabbixAPI),\n                                           this.historyPromises, getHistoryRequestHash);\n\n      if (this.dbConnector) {\n        this.getHistoryDB = callAPIRequestOnce(_.bind(this.dbConnector.getHistory, this.dbConnector),\n                                               this.historyPromises, getDBQueryHash);\n        this.getTrendsDB = callAPIRequestOnce(_.bind(this.dbConnector.getTrends, this.dbConnector),\n                                              this.historyPromises, getDBQueryHash);\n      }\n\n      // Don't run duplicated requests\n      this.groupPromises = {};\n      this.getGroupsOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getGroups, this.zabbixAPI),\n                                              this.groupPromises, getRequestHash);\n\n      this.hostPromises = {};\n      this.getHostsOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getHosts, this.zabbixAPI),\n                                             this.hostPromises, getRequestHash);\n\n      this.appPromises = {};\n      this.getAppsOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getApps, this.zabbixAPI),\n                                            this.appPromises, getRequestHash);\n\n      this.itemPromises = {};\n      this.getItemsOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getItems, this.zabbixAPI),\n                                             this.itemPromises, getRequestHash);\n\n      this.macroPromises = {};\n      this.getMacrosOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getMacros, this.zabbixAPI),\n                                             this.macroPromises, getRequestHash);\n\n      this.globalMacroPromises = {};\n      this.getGlobalMacrosOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getGlobalMacros, this.zabbixAPI),\n                                                    this.globalMacroPromises, getRequestHash);\n    }\n\n    isExpired(cacheObject) {\n      if (cacheObject) {\n        let object_age = Date.now() - cacheObject.timestamp;\n        return !(cacheObject.timestamp && object_age < this.ttl);\n      } else {\n        return true;\n      }\n    }\n\n    /**\n     * Check that result is present in cache and up to date\n     * or send request to API.\n     */\n    proxyRequest(request, params, cacheObject) {\n      let hash = getRequestHash(params);\n      if (this.cacheEnabled && !this.isExpired(cacheObject[hash])) {\n        return Promise.resolve(cacheObject[hash].value);\n      } else {\n        return request(...params)\n        .then(result => {\n          cacheObject[hash] = {\n            value: result,\n            timestamp: Date.now()\n          };\n          return result;\n        });\n      }\n    }\n\n    getGroups() {\n      return this.proxyRequest(this.getGroupsOnce, [], this.cache.groups);\n    }\n\n    getHosts(groupids) {\n      return this.proxyRequest(this.getHostsOnce, [groupids], this.cache.hosts);\n    }\n\n    getApps(hostids) {\n      return this.proxyRequest(this.getAppsOnce, [hostids], this.cache.applications);\n    }\n\n    getItems(hostids, appids, itemtype) {\n      let params = [hostids, appids, itemtype];\n      return this.proxyRequest(this.getItemsOnce, params, this.cache.items);\n    }\n\n    getMacros(hostids) {\n      // Merge global macros and host macros\n      let promises = [\n        this.proxyRequest(this.getMacrosOnce, [hostids], this.cache.macros),\n        this.proxyRequest(this.getGlobalMacrosOnce, [], this.cache.globalMacros)\n      ];\n\n      return Promise.all(promises).then(_.flatten);\n    }\n\n    getHistoryFromCache(items, time_from, time_till) {\n      var historyStorage = this.cache.history;\n      var full_history;\n      var expired = _.filter(_.keyBy(items, 'itemid'), (item, itemid) => {\n        return !historyStorage[itemid];\n      });\n      if (expired.length) {\n        return this.zabbixAPI.getHistory(expired, time_from, time_till).then(function(history) {\n          var grouped_history = _.groupBy(history, 'itemid');\n          _.forEach(expired, item => {\n            var itemid = item.itemid;\n            historyStorage[itemid] = item;\n            historyStorage[itemid].time_from = time_from;\n            historyStorage[itemid].time_till = time_till;\n            historyStorage[itemid].history = grouped_history[itemid];\n          });\n          full_history = _.map(items, item => {\n            return historyStorage[item.itemid].history;\n          });\n          return _.flatten(full_history, true);\n        });\n      } else {\n        full_history = _.map(items, function(item) {\n          return historyStorage[item.itemid].history;\n        });\n        return Promise.resolve(_.flatten(full_history, true));\n      }\n    }\n\n    getHistoryFromAPI(items, time_from, time_till) {\n      return this.zabbixAPI.getHistory(items, time_from, time_till);\n    }\n  }\n\n  return ZabbixCachingProxy;\n}\n\nangular\n  .module('grafana.services')\n  .factory('ZabbixCachingProxy', ZabbixCachingProxyFactory);\n\n/**\n * Wrap zabbix API request to prevent multiple calls\n * with same params when waiting for result.\n */\nfunction callAPIRequestOnce(func, promiseKeeper, argsHashFunc) {\n  return function() {\n    var hash = argsHashFunc(arguments);\n    if (!promiseKeeper[hash]) {\n      promiseKeeper[hash] = Promise.resolve(\n        func.apply(this, arguments)\n        .then(result => {\n          promiseKeeper[hash] = null;\n          return result;\n        })\n      );\n    }\n    return promiseKeeper[hash];\n  };\n}\n\nfunction getRequestHash(args) {\n  var requestStamp = _.map(args, arg => {\n    if (arg === undefined) {\n      return 'undefined';\n    } else {\n      if (_.isArray(arg)) {\n        return arg.sort().toString();\n      } else {\n        return arg.toString();\n      }\n    }\n  }).join();\n  return requestStamp.getHash();\n}\n\nfunction getHistoryRequestHash(args) {\n  let itemids = _.map(args[0], 'itemid');\n  let stamp = itemids.join() + args[1] + args[2];\n  return stamp.getHash();\n}\n\nfunction getDBQueryHash(args) {\n  let itemids = _.map(args[0], 'itemid');\n  let consolidateBy = args[3].consolidateBy;\n  let intervalMs = args[3].intervalMs;\n  let stamp = itemids.join() + args[1] + args[2] + consolidateBy + intervalMs;\n  return stamp.getHash();\n}\n\nString.prototype.getHash = function() {\n  var hash = 0, i, chr, len;\n  if (this.length !== 0) {\n    for (i = 0, len = this.length; i < len; i++) {\n      chr   = this.charCodeAt(i);\n      hash  = ((hash << 5) - hash) + chr;\n      hash |= 0; // Convert to 32bit integer\n    }\n  }\n  return hash;\n};\n\n// Fix for backward compatibility with lodash 2.4\nif (!_.keyBy) {_.keyBy = _.indexBy;}\n"]}